FROM maven:3.9.9-eclipse-temurin-21 AS backend

WORKDIR /app

# Wrapper Maven
COPY ./backend/.mvn/ .mvn/
COPY ./backend/mvnw ./
RUN chmod +x mvnw

# POMs d'abord
COPY pom.xml ./
COPY ./backend/pom.xml ./backend/
COPY ./shared_common/pom.xml ./shared_common/

# ✅ Copier le code source de shared_common et backend
COPY ./shared_common/src /app/shared_common/src
COPY ./backend/src /app/backend/src

# ✅ CORRECTION : Construire en utilisant le parent POM
RUN ./mvnw clean install -DskipTests

# Démarrage
CMD ["./mvnw", "-pl", "backend", "-am", "spring-boot:run", "-DskipTests"]